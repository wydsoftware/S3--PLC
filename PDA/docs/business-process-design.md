# 移动端派工系统业务流程设计

## 流程概述

本文档详细描述移动端派工系统的核心业务流程，包括设备派工、生产控制、设备维修、状态查询等主要功能模块的业务逻辑和操作流程。

## 1. 用户登录流程

### 1.1 流程图
```
开始 → 输入用户名密码 → 验证用户信息 → 生成JWT Token → 返回用户信息 → 进入主界面
  ↓                    ↓
  ↓                 验证失败
  ↓                    ↓
  ↓                 返回错误信息
  ↓                    ↓
  ↓                 重新输入
  ↓                    ↑
  ↓←←←←←←←←←←←←←←←←←←←←←←
```

### 1.2 详细步骤
1. **用户输入**: 用户在登录界面输入用户名和密码
2. **参数验证**: 系统验证输入参数的格式和完整性
3. **用户认证**: 系统查询数据库验证用户名和密码
4. **状态检查**: 验证用户账户状态是否为活跃状态
5. **Token生成**: 生成JWT Token，包含用户ID、用户名、角色等信息
6. **登录记录**: 记录用户登录时间和IP地址
7. **返回结果**: 返回Token和用户基本信息
8. **界面跳转**: 跳转到系统主界面

### 1.3 异常处理
- 用户名或密码错误：提示"用户名或密码错误"
- 账户被禁用：提示"账户已被禁用，请联系管理员"
- 系统异常：提示"系统异常，请稍后重试"

## 2. 设备派工流程

### 2.1 流程图
```
开始 → 选择设备类型 → 选择具体设备 → 输入派工信息 → 确认派工 → PLC通信验证 → 创建派工单 → 开始生产 → 结束
  ↓         ↓            ↓            ↓           ↓          ↓            ↓          ↓
  ↓      获取设备列表   检查设备状态   填写派工单号   弹窗确认    设备清零验证   保存数据库   更新设备状态
  ↓         ↓            ↓            ↓           ↓          ↓            ↓          ↓
  ↓      过滤可用设备   设备不可用     预计生产数量   用户确认    清零失败      记录日志    提示成功
  ↓         ↓            ↓            ↓           ↓          ↓            ↓          ↓
  ↓      返回设备信息   提示维修中     验证数据格式   取消操作    重试3次       清空表单    返回主界面
```

### 2.2 详细步骤

#### 2.2.1 设备选择阶段
1. **设备类型选择**: 用户从CNC、CCM08、CCM32中选择设备类型
2. **设备列表获取**: 系统根据设备类型获取对应的设备列表
3. **设备状态过滤**: 过滤掉维修中和故障的设备，只显示空闲设备
4. **设备信息展示**: 显示设备编号、名称、当前状态等信息

#### 2.2.2 派工信息录入阶段
1. **派工单号输入**: 用户手动输入派工单号
2. **派工单号验证**: 系统验证派工单号格式和唯一性
3. **预计数量输入**: 用户输入预计生产数量
4. **数据格式验证**: 验证数量为正整数且在合理范围内

#### 2.2.3 派工确认阶段
1. **信息确认弹窗**: 显示派工单号、设备编号、预计数量等信息
2. **用户确认**: 用户点击确认或取消
3. **取消处理**: 如用户取消，返回派工信息录入界面

#### 2.2.4 PLC通信验证阶段
1. **PLC连接**: 使用配置的PLC IP地址建立TCP连接
2. **清零指令发送**: 向设备对应的PLC点位写入清零指令(写入1)
3. **等待处理**: 等待1秒钟让PLC处理清零指令
4. **验证读取**: 读取对应数据点位的值
5. **结果判断**: 
   - 如果值为0，表示清零成功，继续下一步
   - 如果值不为0，重试读取，最多重试3次
   - 3次重试后仍不为0，提示设备或网络问题

#### 2.2.5 派工单创建阶段
1. **数据库记录**: 在work_orders表中创建派工单记录
2. **设备状态更新**: 将设备状态更新为"running"
3. **操作日志**: 记录派工操作日志
4. **成功提示**: 显示"已安排生产"提示信息
5. **界面清空**: 清空所有输入字段，准备下次操作

### 2.3 异常处理
- **设备不可用**: 提示"设备正在维修中，无法安排生产"
- **派工单号重复**: 提示"派工单号已存在，请重新输入"
- **PLC通信失败**: 提示"设备或网络有问题，请检查"
- **数据保存失败**: 提示"系统异常，派工失败"

## 3. 设备停止生产流程

### 3.1 流程图
```
开始 → 获取运行中派工单 → 卡片式展示 → 选择要停止的派工单 → 确认停止 → 输入实际产量 → 更新数据库 → 生成生产记录 → 结束
  ↓         ↓              ↓           ↓                ↓         ↓            ↓          ↓
  ↓      查询数据库        显示设备信息   用户选择派工单     弹窗确认   可选输入      更新状态    记录生产数据
  ↓         ↓              ↓           ↓                ↓         ↓            ↓          ↓
  ↓      过滤运行状态      计算完成比例   高亮选中项        用户确认   验证数据      设备状态     计算效率
  ↓         ↓              ↓           ↓                ↓         ↓            ↓          ↓
  ↓      返回派工单列表    实时更新数据   显示确认信息      取消操作   默认当前值    释放设备     提示完成
```

### 3.2 详细步骤

#### 3.2.1 运行中派工单获取
1. **数据查询**: 查询状态为"running"的派工单
2. **关联查询**: 关联设备信息获取设备名称等详细信息
3. **实时数据**: 获取当前已生产数量（从PLC或手动录入）
4. **计算指标**: 计算完成比例、生产时长等指标

#### 3.2.2 卡片式展示
1. **卡片布局**: 每个运行中的派工单显示为一个卡片
2. **关键信息显示**:
   - 设备编号和名称
   - 派工单号
   - 预计生产数量
   - 当前已生产数量
   - 生产开始时间
   - 完成比例（百分比和进度条）
   - 已运行时长
3. **状态图标**: 显示生产状态图标
4. **操作按钮**: 每个卡片包含"停止生产"按钮

#### 3.2.3 停止确认阶段
1. **选择派工单**: 用户点击某个派工单的"停止生产"按钮
2. **确认弹窗**: 显示确认对话框，包含：
   - 派工单号
   - 设备编号
   - 当前生产进度
   - "确认停止"和"取消"按钮
3. **用户决策**: 用户选择确认或取消操作

#### 3.2.4 实际产量录入
1. **产量输入**: 可选择输入实际完成数量
2. **默认值**: 如不输入，使用当前PLC读取的数量
3. **数据验证**: 验证输入数量的合理性
4. **备注信息**: 可选择添加停止原因备注

#### 3.2.5 数据更新阶段
1. **派工单更新**: 更新work_orders表中的状态、结束时间、实际数量
2. **生产记录创建**: 在production_records表中创建完整的生产记录
3. **设备状态更新**: 将设备状态更新为"idle"
4. **统计数据更新**: 更新相关的统计数据
5. **操作日志**: 记录停止生产的操作日志

### 3.3 数据计算
- **完成比例**: (实际数量 / 预计数量) × 100%
- **生产时长**: 结束时间 - 开始时间
- **生产效率**: 实际数量 / 生产时长（件/小时）
- **设备利用率**: 实际生产时间 / 计划生产时间

### 3.4 异常处理
- **无运行中派工单**: 显示"当前没有正在生产的派工单"
- **数据更新失败**: 提示"停止生产失败，请重试"
- **PLC通信异常**: 使用手动输入的数量或最后一次成功读取的数量

## 4. 设备报修流程

### 4.1 流程图
```
开始 → 选择设备 → 填写故障描述 → 选择维修类型 → 设置优先级 → 提交报修 → 更新设备状态 → 生成维修单 → 通知维修人员 → 结束
  ↓       ↓          ↓            ↓            ↓          ↓          ↓            ↓          ↓
  ↓    设备列表     故障现象       维修分类      紧急程度    创建记录    设为维修中    分配维修单号   发送通知
  ↓       ↓          ↓            ↓            ↓          ↓          ↓            ↓          ↓
  ↓    过滤条件     详细描述       预防/纠正     低/中/高    数据验证    禁用生产      记录日志      邮件/短信
```

### 4.2 详细步骤

#### 4.2.1 设备选择阶段
1. **设备列表展示**: 显示所有48台设备的列表
2. **设备分类**: 按设备类型（AOI、CNC、CCM08、CCM23）分组显示
3. **状态标识**: 显示每台设备的当前状态（空闲/运行中/维修中/故障）
4. **设备信息**: 显示设备编号、名称、位置等基本信息
5. **选择限制**: 已在维修中的设备显示特殊标识，但仍可选择（追加报修）

#### 4.2.2 故障信息录入
1. **故障描述**: 用户输入详细的故障现象描述
2. **维修类型选择**:
   - **预防性维修**: 定期保养、预防性检查
   - **纠正性维修**: 故障修复、部件更换
   - **紧急维修**: 影响生产的紧急故障
3. **优先级设置**:
   - **低**: 不影响生产，可延后处理
   - **中**: 一般故障，正常排期处理
   - **高**: 影响生产效率，优先处理
   - **紧急**: 严重故障，立即处理
4. **附加信息**: 可选择添加故障发生时间、影响范围等信息

#### 4.2.3 报修提交阶段
1. **数据验证**: 验证必填字段的完整性和格式
2. **维修单号生成**: 自动生成维修单号（格式：MR + 日期 + 序号）
3. **数据库记录**: 在maintenance_records表中创建维修记录
4. **设备状态更新**: 将设备状态更新为"maintenance"
5. **操作日志**: 记录报修操作的详细日志

#### 4.2.4 后续处理
1. **维修人员分配**: 根据设备类型和故障类型自动分配或手动指定维修人员
2. **通知发送**: 向维修人员发送维修任务通知
3. **生产限制**: 设备在维修期间无法被选择进行生产派工
4. **状态同步**: 在设备状态查询中实时显示维修状态

### 4.3 维修完成流程
1. **维修开始**: 维修人员开始维修，更新状态为"in_progress"
2. **维修过程**: 记录维修过程、使用的配件、维修方法等
3. **维修完成**: 填写维修结果、解决方案、维修费用等信息
4. **状态恢复**: 将设备状态更新为"idle"，可重新安排生产
5. **验收确认**: 可选择添加维修验收环节

### 4.4 异常处理
- **重复报修**: 同一设备同一故障的重复报修合并处理
- **紧急故障**: 紧急维修自动提升优先级并立即通知
- **维修资源不足**: 根据优先级排队等待维修人员

## 5. 设备状态查询流程

### 5.1 流程图
```
开始 → 获取所有设备信息 → 实时状态更新 → 分类展示 → 状态筛选 → 详情查看 → 结束
  ↓         ↓                ↓            ↓        ↓          ↓
  ↓      查询数据库          PLC数据同步    设备分组   条件过滤    设备详情
  ↓         ↓                ↓            ↓        ↓          ↓
  ↓      关联派工单信息      当前生产数据    状态统计   多条件组合  历史记录
```

### 5.2 详细步骤

#### 5.2.1 数据获取阶段
1. **设备基础信息**: 从equipment表获取所有48台设备的基础信息
2. **当前状态**: 获取每台设备的实时状态（空闲/运行中/维修中/故障）
3. **关联信息查询**:
   - 运行中设备：关联当前派工单信息
   - 维修中设备：关联维修记录信息
   - 故障设备：关联故障记录信息
4. **实时数据**: 从PLC获取正在生产设备的实时生产数据

#### 5.2.2 状态分类展示
1. **按状态分组**:
   - **有生产**: 显示当前绑定的派工单号、生产进度
   - **闲置**: 显示可用于生产派工
   - **维修中**: 显示维修单号、维修原因、预计完成时间
   - **故障**: 显示故障描述、故障时间

2. **按设备类型分组**:
   - **AOI设备**: 2台设备状态
   - **CNC设备**: 16台设备状态
   - **CCM08设备**: 24台设备状态
   - **CCM23设备**: 6台设备状态

#### 5.2.3 状态筛选功能
1. **状态筛选**: 可按设备状态筛选显示
2. **类型筛选**: 可按设备类型筛选显示
3. **组合筛选**: 支持多条件组合筛选
4. **搜索功能**: 支持按设备编号或名称搜索

#### 5.2.4 详情查看
1. **设备详情**: 点击设备可查看详细信息
2. **历史记录**: 查看设备的历史派工和维修记录
3. **性能统计**: 显示设备的利用率、效率等统计数据
4. **实时监控**: 对于运行中的设备，显示实时生产数据

### 5.3 状态更新机制
1. **定时刷新**: 每30秒自动刷新设备状态
2. **手动刷新**: 用户可手动触发状态刷新
3. **推送更新**: 设备状态变化时主动推送更新
4. **离线处理**: 网络异常时显示最后一次成功获取的状态

## 6. PLC IP设定流程

### 6.1 流程图
```
开始 → 获取当前配置 → 显示配置界面 → 用户修改IP → 连接测试 → 保存配置 → 更新系统配置 → 结束
  ↓         ↓            ↓            ↓          ↓        ↓          ↓
  ↓      读取配置表      IP地址输入     格式验证    TCP连接   数据库更新  全局生效
  ↓         ↓            ↓            ↓          ↓        ↓          ↓
  ↓      默认配置        端口设置       IP有效性    超时设置   配置备份    重启服务
```

### 6.2 详细步骤

#### 6.2.1 配置获取阶段
1. **当前配置读取**: 从system_config表读取当前PLC配置
2. **默认配置**: 如无配置则使用系统默认值
3. **配置展示**: 在界面上显示当前的IP地址、端口等配置

#### 6.2.2 配置修改阶段
1. **IP地址输入**: 用户输入新的PLC IP地址
2. **端口设置**: 可选择修改通信端口（默认502）
3. **超时设置**: 可设置连接超时时间
4. **重试次数**: 可设置通信失败重试次数

#### 6.2.3 配置验证阶段
1. **格式验证**: 验证IP地址格式的正确性
2. **网络可达性**: 检查IP地址是否可达
3. **连接测试**: 尝试建立TCP连接到指定的IP和端口
4. **通信测试**: 发送测试指令验证PLC通信是否正常

#### 6.2.4 配置保存阶段
1. **数据库更新**: 将新配置保存到system_config表
2. **配置备份**: 备份旧配置以便回滚
3. **全局更新**: 更新系统中所有使用PLC配置的模块
4. **服务重启**: 必要时重启PLC通信服务

### 6.3 异常处理
- **IP格式错误**: 提示"IP地址格式不正确"
- **连接失败**: 提示"无法连接到PLC，请检查网络和IP地址"
- **通信测试失败**: 提示"PLC通信测试失败，请检查PLC设备状态"
- **保存失败**: 提示"配置保存失败，请重试"

## 7. 后台管理流程

### 7.1 角色管理流程

#### 7.1.1 用户创建流程
```
开始 → 填写用户信息 → 数据验证 → 密码加密 → 保存用户 → 分配权限 → 发送通知 → 结束
  ↓         ↓            ↓        ↓        ↓        ↓        ↓
  ↓      基本信息输入    格式检查   BCrypt   数据库插入  角色设置  邮件通知
  ↓         ↓            ↓        ↓        ↓        ↓        ↓
  ↓      用户名/密码     唯一性检查  哈希加密  记录日志   权限配置  账户激活
```

#### 7.1.2 用户管理操作
1. **用户列表**: 分页显示所有用户信息
2. **用户搜索**: 支持按用户名、角色、状态搜索
3. **用户编辑**: 修改用户基本信息和角色
4. **密码重置**: 管理员可重置用户密码
5. **用户禁用**: 禁用或启用用户账户
6. **权限管理**: 分配和修改用户权限

### 7.2 生产记录查询流程

#### 7.2.1 查询条件设置
1. **时间范围**: 设置查询的开始和结束时间
2. **派工单号**: 精确或模糊匹配派工单号
3. **设备编号**: 选择特定设备或设备类型
4. **生产状态**: 筛选不同状态的生产记录
5. **操作员**: 按操作员筛选记录

#### 7.2.2 数据查询和展示
1. **数据库查询**: 根据条件查询production_records表
2. **关联查询**: 关联设备、用户等相关信息
3. **分页处理**: 大数据量时进行分页显示
4. **排序功能**: 支持按时间、数量等字段排序
5. **导出功能**: 支持导出Excel格式的查询结果

### 7.3 报表管理流程

#### 7.3.1 月度生产报表
1. **数据统计**: 按月统计各设备的生产数据
2. **指标计算**: 计算完成率、效率、利用率等关键指标
3. **图表生成**: 生成柱状图、折线图等可视化图表
4. **报表导出**: 支持PDF、Excel格式导出

#### 7.3.2 设备效率分析
1. **效率排名**: 按设备效率进行排名
2. **趋势分析**: 分析设备效率的变化趋势
3. **对比分析**: 不同设备类型的效率对比
4. **异常识别**: 识别效率异常的设备和时间段

## 8. 数据同步流程

### 8.1 PLC数据同步
1. **定时任务**: 每分钟从PLC读取生产数据
2. **数据解析**: 解析PLC返回的数据格式
3. **数据验证**: 验证数据的合理性和完整性
4. **数据更新**: 更新work_orders表中的实际产量
5. **异常处理**: 处理PLC通信异常和数据异常

### 8.2 统计数据更新
1. **日终统计**: 每日凌晨统计前一天的生产数据
2. **实时统计**: 重要指标实时计算和更新
3. **历史数据**: 定期归档历史统计数据
4. **数据校验**: 定期校验统计数据的准确性

## 9. 异常处理机制

### 9.1 系统异常处理
1. **异常捕获**: 全局异常处理器捕获所有未处理异常
2. **异常分类**: 按异常类型进行分类处理
3. **异常记录**: 记录异常详情到日志文件
4. **用户提示**: 向用户显示友好的错误提示
5. **异常恢复**: 尝试自动恢复或提供恢复建议

### 9.2 业务异常处理
1. **数据验证**: 在业务逻辑层进行数据验证
2. **状态检查**: 检查业务对象的状态是否允许操作
3. **权限验证**: 验证用户是否有权限执行操作
4. **业务规则**: 执行业务规则验证
5. **回滚机制**: 操作失败时回滚数据变更

### 9.3 网络异常处理
1. **连接重试**: PLC通信失败时自动重试
2. **超时处理**: 设置合理的超时时间
3. **离线模式**: 网络异常时支持离线操作
4. **数据缓存**: 缓存重要数据以应对网络异常
5. **状态同步**: 网络恢复后同步离线期间的数据变更

## 10. 性能优化策略

### 10.1 数据库优化
1. **索引优化**: 为常用查询字段创建合适的索引
2. **查询优化**: 优化复杂查询的SQL语句
3. **分页查询**: 大数据量查询使用分页
4. **连接池**: 使用数据库连接池提高性能
5. **读写分离**: 必要时实现读写分离

### 10.2 缓存策略
1. **数据缓存**: 缓存频繁访问的数据
2. **查询缓存**: 缓存复杂查询的结果
3. **配置缓存**: 缓存系统配置信息
4. **缓存更新**: 数据变更时及时更新缓存
5. **缓存失效**: 设置合理的缓存失效时间

### 10.3 并发控制
1. **乐观锁**: 使用版本号实现乐观锁控制
2. **悲观锁**: 关键操作使用悲观锁
3. **分布式锁**: 集群环境下使用分布式锁
4. **队列处理**: 使用消息队列处理高并发请求
5. **限流控制**: 实现接口限流防止系统过载